<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekomendasi - SmartTailor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Segoe UI', sans-serif;
}

body{
    background: linear-gradient(135deg, #667eea, #764ba2);
    min-height:100vh;
    padding:20px;
    padding-bottom:100px;
    color:white;
}

h2{
    text-align:center;
    margin-bottom:20px;
    font-weight:600;
}

.card{
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(15px);
    border-radius:18px;
    padding:20px;
    box-shadow:0 8px 25px rgba(0,0,0,0.2);
    margin-bottom:20px;
}

input[type="file"]{
    width:100%;
    padding:10px;
    background:white;
    border-radius:10px;
    border:none;
}

#preview, .img-fluid{
    width:100%;
    border-radius:12px;
    margin-top:15px;
}

.btn{
    width:100%;
    padding:14px;
    border:none;
    border-radius:12px;
    font-weight:bold;
    font-size:16px;
    cursor:pointer;
    transition:0.3s;
    margin-top:15px;
}

.btn-primary{
    background:white;
    color:#764ba2;
}

.btn-success{
    background:#28a745;
    color:white;
}

.btn-secondary{
    background:rgba(255,255,255,0.3);
    color:white;
}

.btn:hover{
    transform:translateY(-2px);
}

.loading{
    text-align:center;
    font-weight:bold;
    margin-top:15px;
}

.results-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:15px;
    margin-top:15px;
}

.result-item{
    background:rgba(255,255,255,0.2);
    border-radius:15px;
    padding:10px;
    text-align:center;
    animation:fadeIn 0.4s ease;
}

.result-item img{
    width:100%;
    border-radius:10px;
}

.match{
    margin-top:8px;
    font-size:14px;
    font-weight:bold;
}

@keyframes fadeIn{
    from{opacity:0; transform:translateY(10px);}
    to{opacity:1; transform:translateY(0);}
}

.bottom-nav{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    display:flex;
    justify-content:space-around;
    background:rgba(0,0,0,0.3);
    padding:12px 0;
    backdrop-filter:blur(10px);
}

.bottom-nav a{
    color:white;
    text-decoration:none;
    font-size:14px;
    display:flex;
    flex-direction:column;
    align-items:center;
}

.bottom-nav a.active{
    font-weight:bold;
}
</style>
</head>
<body>

<h2>üëó Upload Gambar Busana</h2>

<div class="card">
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="image" id="fileInput" onchange="previewFile(event)" required>
        <img id="preview" style="display:none;">

        <button type="submit" class="btn btn-primary" id="btnProses">
            üì∑ Proses Rekomendasi
        </button>
    </form>

    <div id="loading" class="loading" style="display:none">
        ‚è≥ Memproses AI...
    </div>
</div>

<div id="resultContainer"></div>

<div class="card">
    <a href="/" style="text-decoration:none;">
        <button class="btn btn-secondary">‚¨Ö Kembali ke Dashboard</button>
    </a>
</div>

<div class="bottom-nav">
    <a href="/">üè†<span>Home</span></a>
    <a href="#" class="active">‚¨Ü<span>Upload</span></a>
    <a href="/riwayat">üïì<span>Riwayat</span></a>
</div>

<script>
function previewFile(e){
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = function(event){
            const img = document.getElementById("preview");
            img.src = event.target.result;
            img.style.display = "block";
        }
        reader.readAsDataURL(file);
    }
}

const form = document.getElementById("uploadForm");

form.addEventListener("submit", async function(e){
    e.preventDefault();

    const loading = document.getElementById("loading");
    const container = document.getElementById("resultContainer");
    const btn = document.getElementById("btnProses");

    loading.style.display = "block";
    container.innerHTML = "";
    btn.disabled = true;
    btn.innerText = "‚è≥ Memproses...";

    const formData = new FormData(form);
    formData.append("tubuh", "{{ tubuh }}");

    try{
        const response = await fetch("/api/rekomendasi",{
            method:"POST",
            body:formData
        });

        const data = await response.json();

        loading.style.display = "none";
        btn.disabled = false;
        btn.innerText = "üì∑ Proses Rekomendasi";

        if(data.error){
            alert(data.error);
            return;
        }

        container.innerHTML += `
            <div class="card">
                <h3>Gambar Input</h3>
                <img src="${data.input_image}" class="img-fluid">
                <p style="margin-top:10px;">
                    Kategori: <b>${data.category}</b><br>
                    Confidence: <b>${(data.confidence * 100).toFixed(2)}%</b>
                </p>
            </div>
        `;

        container.innerHTML += `<h3 style="text-align:center;">‚ú® Hasil Rekomendasi</h3>`;
        let grid = document.createElement("div");
        grid.className = "results-grid";
        container.appendChild(grid);

        for(let i=0;i<data.results.length;i++){
            await new Promise(resolve => setTimeout(resolve, 250));

            const r = data.results[i];

            grid.innerHTML += `
                <div class="result-item">
                    <img src="${r.image}">
                    <div class="match">
                        Match ${(r.score * 100).toFixed(1)}%
                    </div>
                </div>
            `;
        }

        container.innerHTML += `
            <div class="card">
                <form action="/simpan" method="POST">
                    <input type="hidden" name="tubuh" value="{{ tubuh }}">
                    <input type="hidden" name="input_image" value="${data.input_image}">
                    <input type="hidden" name="category" value="${data.category}">
                    ${data.results.map(r => `
                        <input type="hidden" name="image_path[]" value="${r.image}">
                        <input type="hidden" name="score[]" value="${r.score}">
                    `).join('')}
                    <button type="submit" class="btn btn-success">
                        üíæ Simpan ke Riwayat
                    </button>
                </form>
            </div>
        `;

    }catch(err){
        loading.style.display="none";
        btn.disabled=false;
        btn.innerText="üì∑ Proses Rekomendasi";
        alert("Terjadi kesalahan koneksi.");
    }
});
</script>

</body>
</html>
